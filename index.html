<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katelya-TGBed | 免费文件托管服务</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/theme-chalk/index.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <style>
    :root {
      --primary-color: #8a4bff;
      --primary-light: #b39ddb;
      --primary-dark: #6c3ce0;
      --accent-color: #ffd7e4;
      --success-color: #67c23a;
      --warning-color: #e6a23c;
      --danger-color: #f56c6c;
      --info-color: #909399;
      --bg-gradient: linear-gradient(135deg, #ffd7e4 0%, #c8f1ff 100%);
      --card-bg: rgba(255, 255, 255, 0.92);
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 8px 24px rgba(138, 75, 255, 0.15);
      --border-radius: 16px;
      --transition: all 0.2s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg-gradient);
      background-attachment: fixed;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans SC', sans-serif;
      color: #333;
    }

    /* 页面加载动画 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #app {
      animation: fadeIn 0.5s ease-out;
    }

    #app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* 头部导航 */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 28px;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.5);
      position: sticky;
      top: 20px;
      z-index: 100;
      will-change: transform;
    }

    .header-title {
      font-size: 1.5em;
      font-weight: 700;
      color: #333;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: var(--transition);
    }

    .header-title:hover {
      transform: scale(1.02);
    }

    .header-title i {
      color: var(--primary-color);
      font-size: 1.1em;
    }

    .nav-links {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .nav-links a {
      padding: 10px 18px;
      border-radius: 10px;
      text-decoration: none;
      color: #555;
      transition: var(--transition);
      font-size: 0.9em;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-links a:hover {
      background: linear-gradient(135deg, rgba(138, 75, 255, 0.1), rgba(255, 215, 228, 0.3));
      color: var(--primary-color);
      transform: translateY(-2px);
    }

    .nav-links .logout-link {
      color: var(--danger-color);
      border: 1.5px solid var(--danger-color);
    }

    .nav-links .logout-link:hover {
      background: var(--danger-color);
      color: white;
      transform: translateY(-2px);
    }

    /* 主容器 */
    .main-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .main-container {
        grid-template-columns: 1fr;
      }
    }

    /* 卡片样式 */
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      padding: 28px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-hover);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-size: 1.25em;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title i {
      color: var(--primary-color);
      font-size: 1.1em;
    }

    /* 上传区域 */
    .upload-zone {
      border: 2.5px dashed var(--primary-light);
      border-radius: 20px;
      padding: 50px 40px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      background: linear-gradient(135deg, rgba(138, 75, 255, 0.03) 0%, rgba(255, 215, 228, 0.08) 100%);
      position: relative;
      overflow: hidden;
    }

    .upload-zone::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(138, 75, 255, 0.08) 0%, rgba(255, 215, 228, 0.15) 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .upload-zone:hover::before, .upload-zone.dragover::before {
      opacity: 1;
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--primary-color);
      transform: scale(1.01);
      box-shadow: 0 8px 30px rgba(138, 75, 255, 0.15);
    }

    .upload-zone.dragover {
      box-shadow: 0 0 30px rgba(138, 75, 255, 0.25);
    }

    .upload-icon {
      font-size: 4em;
      color: var(--primary-light);
      margin-bottom: 20px;
      transition: var(--transition);
      position: relative;
      z-index: 1;
    }

    .upload-zone:hover .upload-icon {
      color: var(--primary-color);
      transform: translateY(-5px);
    }

    .upload-text {
      font-size: 1.2em;
      color: #555;
      margin-bottom: 10px;
      font-weight: 500;
      position: relative;
      z-index: 1;
    }

    .upload-hint {
      font-size: 0.9em;
      color: #888;
      position: relative;
      z-index: 1;
    }

    .storage-target {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(138, 75, 255, 0.1) 0%, rgba(200, 241, 255, 0.3) 100%);
      border-radius: 20px;
      font-size: 0.85em;
      color: #8a4bff;
      font-weight: 500;
    }

    .storage-target i {
      font-size: 1em;
    }

    /* 存储切换器 */
    .storage-switcher {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-top: 20px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 215, 228, 0.3) 100%);
      border-radius: 16px;
      border: 1px solid rgba(138, 75, 255, 0.1);
    }

    .storage-label {
      font-size: 0.9em;
      color: #666;
      font-weight: 500;
    }

    .storage-options {
      display: flex;
      gap: 8px;
    }

    .storage-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9em;
      color: #666;
    }

    .storage-btn:hover:not(.disabled) {
      border-color: var(--primary-light);
      background: rgba(138, 75, 255, 0.05);
    }

    .storage-btn.active {
      border-color: var(--primary-color);
      background: linear-gradient(135deg, rgba(138, 75, 255, 0.1) 0%, rgba(179, 157, 219, 0.2) 100%);
      color: var(--primary-color);
      font-weight: 600;
    }

    .storage-btn.active i {
      color: var(--primary-color);
    }

    .storage-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .storage-btn i {
      font-size: 1.1em;
    }

    .upload-input {
      display: none;
    }

    /* 上传方式选择 */
    .upload-methods {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .method-btn {
      padding: 14px 24px;
      border: 2px solid var(--primary-light);
      border-radius: 14px;
      background: white;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95em;
      font-weight: 500;
      color: #555;
    }

    .method-btn:hover {
      border-color: var(--primary-color);
      background: linear-gradient(135deg, rgba(138, 75, 255, 0.08), rgba(255, 215, 228, 0.15));
      color: var(--primary-color);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(138, 75, 255, 0.15);
    }

    .method-btn i {
      color: var(--primary-color);
      font-size: 1.1em;
    }

    /* 上传进度列表 */
    .upload-list {
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
    }

    .upload-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      margin-bottom: 10px;
    }

    .upload-item-preview {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      background: #f0f0f0;
    }

    .upload-item-info {
      flex: 1;
      min-width: 0;
    }

    .upload-item-name {
      font-size: 0.95em;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .upload-item-size {
      font-size: 0.8em;
      color: #999;
      margin-top: 4px;
    }

    .upload-item-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upload-item-status.success { color: #67c23a; }
    .upload-item-status.error { color: #f56c6c; }
    .upload-item-status.uploading { color: var(--primary-color); }

    .upload-item-error {
      font-size: 0.75em;
      color: #f56c6c;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    /* 结果区域 */
    .result-section {
      min-height: 400px;
      overflow: hidden; /* 防止内容溢出 */
    }

    .result-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .result-list {
      margin-top: 16px;
      max-height: 350px;
      overflow-y: auto;
      overflow-x: hidden; /* 防止水平滚动 */
    }

    .result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      margin-bottom: 10px;
      transition: all 0.3s;
      min-width: 0; /* 关键：允许 flex 子元素收缩 */
    }

    .result-item:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateX(4px);
    }

    .result-item.selected {
      border: 2px solid var(--primary-color);
      background: rgba(138, 75, 255, 0.05);
    }

    .result-item-checkbox {
      width: 20px;
      height: 20px;
      min-width: 20px; /* 防止收缩 */
      cursor: pointer;
    }

    .result-item-preview {
      width: 50px;
      height: 50px;
      min-width: 50px; /* 防止收缩 */
      border-radius: 8px;
      object-fit: cover;
      background: #f0f0f0;
      cursor: pointer;
      flex-shrink: 0; /* 防止收缩 */
    }

    .result-item-info {
      flex: 1;
      min-width: 0; /* 关键：允许文本截断 */
      overflow: hidden;
    }

    .result-item-name {
      font-size: 0.9em;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .result-item-link {
      font-size: 0.8em;
      color: var(--primary-color);
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      max-width: 100%;
    }

    .result-item-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0; /* 防止按钮组收缩 */
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      background: rgba(138, 75, 255, 0.1);
      color: var(--primary-color);
    }

    .action-btn:hover {
      background: var(--primary-color);
      color: white;
      transform: scale(1.1);
    }

    .action-btn.delete {
      background: rgba(245, 108, 108, 0.1);
      color: #f56c6c;
    }

    .action-btn.delete:hover {
      background: #f56c6c;
      color: white;
    }

    /* 链接格式选择 */
    .link-format-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .format-tab {
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.3s;
      background: white;
    }

    .format-tab:hover {
      border-color: var(--primary-color);
    }

    .format-tab.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    /* 批量链接文本框 */
    .batch-links {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid #eee;
      border-radius: 12px;
      font-family: 'Consolas', monospace;
      font-size: 0.85em;
      resize: vertical;
      margin-top: 12px;
    }

    .batch-links:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    /* 历史记录 */
    .history-section {
      margin-top: 20px;
    }

    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .history-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }

    .history-item:hover {
      transform: scale(1.05);
    }

    .history-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .history-item-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .history-item:hover .history-item-overlay {
      opacity: 1;
    }

    .history-item.selected .history-item-overlay {
      opacity: 1;
      background: rgba(138, 75, 255, 0.7);
    }

    /* 图片预览弹窗 */
    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 40px;
    }

    .preview-modal img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }

    .preview-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      border: none;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 1.5em;
      cursor: pointer;
      transition: all 0.3s;
    }

    .preview-close:hover {
      background: rgba(255, 255, 255, 0.4);
      transform: rotate(90deg);
    }

    /* 空状态 */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .empty-state i {
      font-size: 3em;
      margin-bottom: 16px;
      color: #ddd;
    }

    /* 统计条 */
    .stats-bar {
      display: flex;
      gap: 20px;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(138, 75, 255, 0.1) 0%, rgba(255, 215, 228, 0.2) 100%);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
      color: #666;
    }

    .stat-item i {
      color: var(--primary-color);
    }

    .stat-value {
      font-weight: bold;
      color: var(--primary-color);
    }

    /* URL 上传弹窗 */
    .url-input-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .url-input-container input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #eee;
      border-radius: 12px;
      font-size: 1em;
    }

    .url-input-container input:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    /* 加载动画 */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* 滚动条美化 */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }

    /* Toast 通知 */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      padding: 12px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 10px;
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast.success { border-left: 4px solid #67c23a; }
    .toast.error { border-left: 4px solid #f56c6c; }
    .toast.info { border-left: 4px solid var(--primary-color); }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* 响应式适配 */
    @media (max-width: 900px) {
      .header {
        position: relative;
        top: 0;
      }
      
      .main-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      #app {
        padding: 16px;
      }

      .header {
        flex-direction: column;
        gap: 12px;
        padding: 14px 18px;
      }

      .header-title {
        font-size: 1.25em;
      }

      .nav-links {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
        gap: 6px;
      }

      .nav-links a {
        padding: 8px 14px;
        font-size: 0.85em;
        gap: 6px;
      }

      .card {
        padding: 20px;
        border-radius: 14px;
      }

      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .card-title {
        font-size: 1.1em;
      }

      .upload-zone {
        padding: 40px 20px;
      }

      .upload-methods {
        flex-direction: column;
        gap: 10px;
      }

      .method-btn {
        justify-content: center;
        width: 100%;
      }

      .main-container {
        gap: 16px;
      }

      .storage-switcher {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .storage-options {
        justify-content: center;
      }

      /* 文件列表优化 */
      .file-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .file-info {
        width: 100%;
      }

      .file-actions {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 8px;
      }

      /* 结果弹窗优化 */
      .result-dialog .el-dialog {
        width: 90% !important;
        margin: 5vh auto !important;
      }
    }

    @media (max-width: 480px) {
      #app {
        padding: 10px;
      }

      .header {
        padding: 12px 14px;
        gap: 10px;
        border-radius: 12px;
        margin-bottom: 16px;
      }

      .header-title {
        font-size: 1.1em;
        gap: 8px;
      }

      .header-title i {
        font-size: 1em;
      }

      .nav-links {
        gap: 4px;
      }

      .nav-links a {
        padding: 6px 10px;
        font-size: 0.78em;
        border-radius: 8px;
        gap: 4px;
      }

      .nav-links a i {
        font-size: 0.9em;
      }

      .card {
        padding: 16px;
        border-radius: 12px;
      }

      .card-header {
        margin-bottom: 16px;
      }

      .card-title {
        font-size: 1em;
        gap: 8px;
      }

      .card-title i {
        font-size: 1em;
      }

      .upload-zone {
        padding: 30px 15px;
        border-radius: 12px;
      }

      .upload-zone i {
        font-size: 2.5em !important;
      }

      .upload-zone p {
        font-size: 0.9em;
      }

      .upload-zone span {
        font-size: 0.8em;
      }

      .upload-methods {
        gap: 8px;
        margin-top: 16px;
      }

      .method-btn {
        padding: 10px 16px;
        font-size: 0.85em;
        border-radius: 10px;
      }

      .storage-label {
        font-size: 0.85em;
      }

      .storage-options {
        gap: 6px;
      }

      .storage-option {
        padding: 8px 14px;
        font-size: 0.82em;
        border-radius: 8px;
      }

      /* 文件项优化 */
      .file-item {
        padding: 12px;
        border-radius: 10px;
      }

      .file-preview {
        width: 50px;
        height: 50px;
      }

      .file-name {
        font-size: 0.88em;
      }

      .file-size {
        font-size: 0.75em;
      }

      .file-actions .el-button {
        padding: 6px 10px;
        font-size: 0.78em;
      }

      /* 进度条优化 */
      .progress-bar {
        height: 4px;
      }

      .progress-info {
        font-size: 0.78em;
      }

      /* Element UI 弹窗优化 */
      .el-message-box {
        width: 90% !important;
        max-width: 300px !important;
      }

      .el-dialog {
        width: 92% !important;
        margin: 8vh auto !important;
      }

      .el-dialog__header {
        padding: 15px 15px 10px;
      }

      .el-dialog__body {
        padding: 15px;
      }

      .el-dialog__footer {
        padding: 10px 15px 15px;
      }

      /* 按钮组优化 */
      .el-button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .el-button-group .el-button {
        margin-left: 0 !important;
        flex: 1;
        min-width: 80px;
      }

      /* 输入框优化 */
      .el-input__inner {
        height: 38px;
        font-size: 14px;
      }

      /* 提示信息优化 */
      .el-message {
        min-width: auto !important;
        max-width: 90% !important;
        padding: 10px 15px !important;
      }

      .el-message__content {
        font-size: 13px !important;
      }

      /* 移动端禁用高消耗效果 */
      .header {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        background: rgba(255, 255, 255, 0.98);
      }

      .card {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        background: rgba(255, 255, 255, 0.98);
      }
    }

    /* 用户偏好减少动画 */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- 头部导航 -->
    <div class="header">
      <div class="header-title">
        <i class="fas fa-cloud-upload-alt"></i>
        <span>Katelya-TGBed</span>
      </div>
      <div class="nav-links">
        <a href="./"><i class="fas fa-home"></i> 首页</a>
        <a href="./gallery.html"><i class="fas fa-images"></i> 图片浏览</a>
        <a href="./admin.html"><i class="fas fa-cog"></i> 管理后台</a>
        <a href="javascript:void(0)" @click="handleLogout" v-if="isAuthenticated" class="logout-link">
          <i class="fas fa-sign-out-alt"></i> 退出
        </a>
      </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-container">
      <!-- 左侧上传区 -->
      <div class="card upload-section">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-upload"></i>
            <span>上传文件</span>
          </div>
          <span style="color: #999; font-size: 0.85em;">支持批量上传，最大 100MB/个（分片上传）</span>
        </div>

        <!-- 上传区域 -->
        <div class="upload-zone" 
             @click="triggerUpload" 
             @dragover.prevent="onDragOver" 
             @dragleave="onDragLeave"
             @drop.prevent="onDrop"
             :class="{ dragover: isDragging }">
          <i class="fas fa-cloud-upload-alt upload-icon"></i>
          <div class="upload-text">点击或拖拽文件到此区域上传</div>
          <div class="upload-hint">支持图片、视频、音频、文档等多种格式，单文件最大 100MB</div>
          <input type="file" class="upload-input" ref="fileInput" multiple @change="handleFileSelect">
        </div>

        <!-- 存储位置切换 -->
        <div class="storage-switcher">
          <span class="storage-label">存储位置：</span>
          <div class="storage-options">
            <button class="storage-btn" :class="{ active: storageMode === 'telegram' }" @click="setStorageMode('telegram')">
              <i class="fab fa-telegram"></i>
              <span>Telegram</span>
            </button>
            <button class="storage-btn" :class="{ active: storageMode === 'r2', disabled: !r2Available }" @click="setStorageMode('r2')" :disabled="!r2Available">
              <i class="fas fa-cloud"></i>
              <span>R2 存储</span>
            </button>
          </div>
        </div>

        <!-- 上传方式按钮 -->
        <div class="upload-methods">
          <button class="method-btn" @click="triggerUpload">
            <i class="fas fa-folder-open"></i>
            <span>选择文件</span>
          </button>
          <button class="method-btn" @click="pasteFromClipboard">
            <i class="fas fa-paste"></i>
            <span>粘贴上传</span>
          </button>
          <button class="method-btn" @click="showUrlInput = !showUrlInput">
            <i class="fas fa-link"></i>
            <span>URL上传</span>
          </button>
        </div>

        <!-- URL上传 -->
        <div class="url-input-container" v-if="showUrlInput">
          <input type="text" v-model="urlToUpload" placeholder="输入图片URL地址..." @keyup.enter="uploadFromUrl">
          <el-button type="primary" @click="uploadFromUrl" :loading="urlUploading">上传</el-button>
        </div>

        <!-- 上传进度列表 -->
        <div class="upload-list" v-if="uploadingFiles.length > 0">
          <div class="card-title" style="margin-top: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <i class="fas fa-tasks"></i>
              <span>上传队列 ({{ uploadingFiles.length }})</span>
              <span v-if="failedCount > 0" style="color: #f56c6c; margin-left: 8px; font-size: 0.85em;">
                ({{ failedCount }} 个失败)
              </span>
            </div>
            <div style="display: flex; gap: 8px;">
              <el-button v-if="failedCount > 0" size="mini" type="warning" @click="retryAllFailed">
                <i class="fas fa-redo"></i> 重试全部失败 ({{ failedCount }})
              </el-button>
              <el-button size="mini" type="info" @click="clearUploadQueue">
                <i class="fas fa-broom"></i> 清空队列
              </el-button>
            </div>
          </div>
          <div class="upload-item" v-for="(file, index) in uploadingFiles" :key="index">
            <img v-if="file.preview" :src="file.preview" class="upload-item-preview">
            <div v-else class="upload-item-preview" style="display: flex; align-items: center; justify-content: center;">
              <i :class="getFileIcon(file.name)" style="font-size: 1.5em; color: #999;"></i>
            </div>
            <div class="upload-item-info">
              <div class="upload-item-name">{{ file.name }}</div>
              <div class="upload-item-size">{{ formatSize(file.size) }}</div>
              <div v-if="file.error" class="upload-item-error">{{ file.error }}</div>
            </div>
            <div class="upload-item-status" :class="file.status">
              <span class="loading-spinner" v-if="file.status === 'uploading'"></span>
              <i class="fas fa-check-circle" v-if="file.status === 'success'"></i>
              <i class="fas fa-times-circle" v-if="file.status === 'error'"></i>
              <span>{{ getStatusText(file.status) }} <span v-if="file.progress">({{ file.progress }}%)</span></span>
            </div>
            <button v-if="file.status === 'error'" class="action-btn" @click="retryUpload(file)" title="重试">
              <i class="fas fa-redo"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- 右侧结果区 -->
      <div class="card result-section">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-images"></i>
            <span>上传结果</span>
            <span v-if="uploadedFiles.length > 0" style="font-size: 0.8em; color: #999; margin-left: 8px;">
              ({{ uploadedFiles.length }}个文件)
            </span>
          </div>
          <div class="result-actions" v-if="uploadedFiles.length > 0">
            <el-button size="mini" type="primary" @click="selectAll">
              {{ isAllSelected ? '取消全选' : '全选' }}
            </el-button>
            <el-button size="mini" type="success" @click="copySelectedLinks" :disabled="selectedCount === 0">
              复制选中 ({{ selectedCount }})
            </el-button>
            <el-button size="mini" type="warning" @click="copyAllLinks">
              复制全部
            </el-button>
            <el-button size="mini" type="danger" @click="clearResults">
              清空
            </el-button>
          </div>
        </div>

        <!-- 链接格式选择 -->
        <div class="link-format-tabs" v-if="uploadedFiles.length > 0">
          <span class="format-tab" :class="{ active: linkFormat === 'url' }" @click="linkFormat = 'url'">直链 URL</span>
          <span class="format-tab" :class="{ active: linkFormat === 'markdown' }" @click="linkFormat = 'markdown'">Markdown</span>
          <span class="format-tab" :class="{ active: linkFormat === 'html' }" @click="linkFormat = 'html'">HTML</span>
          <span class="format-tab" :class="{ active: linkFormat === 'bbcode' }" @click="linkFormat = 'bbcode'">BBCode</span>
          <span class="format-tab" :class="{ active: linkFormat === 'ubb' }" @click="linkFormat = 'ubb'">UBB</span>
        </div>

        <!-- 上传结果列表 -->
        <div class="result-list" v-if="uploadedFiles.length > 0">
          <div class="result-item" 
               v-for="(file, index) in uploadedFiles" 
               :key="index"
               :class="{ selected: file.selected }">
            <input type="checkbox" class="result-item-checkbox" v-model="file.selected">
            <img :src="file.url" class="result-item-preview" @click="previewImage(file.url)" 
                 onerror="this.style.display='none'">
            <div class="result-item-info">
              <div class="result-item-name">{{ file.name }}</div>
              <div class="result-item-link" @click="copyLink(file)" :title="formatLink(file)">
                {{ formatLink(file) }}
              </div>
            </div>
            <div class="result-item-actions">
              <button class="action-btn" @click="copyLink(file)" title="复制链接">
                <i class="fas fa-copy"></i>
              </button>
              <button class="action-btn" @click="downloadFile(file)" title="下载">
                <i class="fas fa-download"></i>
              </button>
              <button class="action-btn" @click="openPreview(file)" title="预览">
                <i class="fas fa-eye"></i>
              </button>
              <button class="action-btn delete" @click="removeFromResults(index)" title="移除">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- 批量复制文本框 -->
        <textarea class="batch-links" 
                  v-if="uploadedFiles.length > 0"
                  :value="getBatchLinks()" 
                  readonly 
                  @click="$event.target.select()"
                  placeholder="选中的链接将显示在这里..."></textarea>

        <!-- 空状态 -->
        <div class="empty-state" v-if="uploadedFiles.length === 0">
          <i class="fas fa-cloud-upload-alt"></i>
          <div>上传文件后，链接将显示在这里</div>
          <div style="margin-top: 8px; font-size: 0.9em;">支持批量选择和一键复制</div>
        </div>
      </div>
    </div>

    <!-- 上传历史区域 -->
    <div class="card history-section" v-if="uploadHistory.length > 0">
      <div class="card-header">
        <div class="card-title">
          <i class="fas fa-history"></i>
          <span>本地上传历史</span>
          <span style="font-size: 0.8em; color: #999; margin-left: 8px;">({{ uploadHistory.length }})</span>
        </div>
        <div class="result-actions">
          <el-button size="mini" type="primary" @click="selectAllHistory">
            {{ isAllHistorySelected ? '取消全选' : '全选' }}
          </el-button>
          <el-button size="mini" type="success" @click="copySelectedHistoryLinks" :disabled="selectedHistoryCount === 0">
            复制选中 ({{ selectedHistoryCount }})
          </el-button>
          <el-button size="mini" type="danger" @click="clearHistory">
            清空历史
          </el-button>
        </div>
      </div>

      <!-- 统计条 -->
      <div class="stats-bar">
        <div class="stat-item">
          <i class="fas fa-images"></i>
          <span>图片: <span class="stat-value">{{ historyStats.images }}</span></span>
        </div>
        <div class="stat-item">
          <i class="fas fa-video"></i>
          <span>视频: <span class="stat-value">{{ historyStats.videos }}</span></span>
        </div>
        <div class="stat-item">
          <i class="fas fa-file"></i>
          <span>其他: <span class="stat-value">{{ historyStats.others }}</span></span>
        </div>
        <div class="stat-item">
          <i class="fas fa-hdd"></i>
          <span>总大小: <span class="stat-value">{{ formatSize(historyStats.totalSize) }}</span></span>
        </div>
      </div>

      <!-- 历史记录网格 -->
      <div class="history-grid">
        <div class="history-item" 
             v-for="(item, index) in uploadHistory" 
             :key="index"
             :class="{ selected: item.selected }"
             @click="toggleHistorySelect(index)">
          <img :src="item.url" onerror="this.parentElement.style.background='#f0f0f0'">
          <div class="history-item-overlay">
            <button class="action-btn" @click.stop="copyLink(item)" style="background: rgba(255,255,255,0.2); color: white;">
              <i class="fas fa-copy"></i>
            </button>
            <button class="action-btn delete" @click.stop="removeFromHistory(index)" style="background: rgba(245,108,108,0.8);">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 图片预览弹窗 -->
    <div class="preview-modal" v-if="previewUrl" @click="previewUrl = null">
      <button class="preview-close" @click="previewUrl = null">
        <i class="fas fa-times"></i>
      </button>
      <img :src="previewUrl" @click.stop>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container">
      <div class="toast" :class="toast.type" v-for="(toast, index) in toasts" :key="index">
        <i :class="getToastIcon(toast.type)"></i>
        <span>{{ toast.message }}</span>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.3/lib/index.js"></script>
  <script>
    new Vue({
      el: '#app',
      data: {
        baseURL: document.location.origin,
        isDragging: false,
        showUrlInput: false,
        urlToUpload: '',
        urlUploading: false,
        uploadingFiles: [],
        uploadedFiles: [],
        uploadHistory: [],
        linkFormat: 'url',
        previewUrl: null,
        toasts: [],
        isAuthenticated: false,
        storageMode: 'telegram', // 存储模式：telegram 或 r2
        storageTarget: 'Telegram 频道', // 显示文本
        r2Available: false, // R2 是否可用
        uploadConfig: {
          maxSize: 100 * 1024 * 1024, // 100MB max (chunked upload)
          chunkSize: 5 * 1024 * 1024, // 5MB chunks
          smallFileThreshold: 20 * 1024 * 1024, // 20MB, below this use direct upload
          maxConcurrent: 3
        }
      },
      computed: {
        selectedCount() {
          return this.uploadedFiles.filter(f => f.selected).length;
        },
        isAllSelected() {
          return this.uploadedFiles.length > 0 && this.uploadedFiles.every(f => f.selected);
        },
        failedCount() {
          return this.uploadingFiles.filter(f => f.status === 'error').length;
        },
        selectedHistoryCount() {
          return this.uploadHistory.filter(f => f.selected).length;
        },
        isAllHistorySelected() {
          return this.uploadHistory.length > 0 && this.uploadHistory.every(f => f.selected);
        },
        historyStats() {
          const stats = { images: 0, videos: 0, others: 0, totalSize: 0 };
          this.uploadHistory.forEach(item => {
            const ext = item.name.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
              stats.images++;
            } else if (['mp4', 'webm', 'avi', 'mov'].includes(ext)) {
              stats.videos++;
            } else {
              stats.others++;
            }
            stats.totalSize += item.size || 0;
          });
          return stats;
        }
      },
      methods: {
        // 上传触发
        triggerUpload() {
          this.$refs.fileInput.click();
        },

        // 处理文件选择
        handleFileSelect(event) {
          const files = Array.from(event.target.files || []);
          this.processFiles(files);
          event.target.value = '';
        },

        // 拖拽事件
        onDragOver() {
          this.isDragging = true;
        },
        onDragLeave() {
          this.isDragging = false;
        },
        onDrop(event) {
          this.isDragging = false;
          const files = Array.from(event.dataTransfer.files || []);
          this.processFiles(files);
        },

        // 粘贴上传
        async pasteFromClipboard() {
          try {
            const items = await navigator.clipboard.read();
            const files = [];
            for (const item of items) {
              for (const type of item.types) {
                if (type.startsWith('image/')) {
                  const blob = await item.getType(type);
                  const ext = type.split('/')[1];
                  const file = new File([blob], `clipboard_${Date.now()}.${ext}`, { type });
                  files.push(file);
                }
              }
            }
            if (files.length > 0) {
              this.processFiles(files);
            } else {
              this.showToast('剪贴板中没有图片', 'error');
            }
          } catch (err) {
            this.showToast('无法访问剪贴板，请直接粘贴图片', 'error');
          }
        },

        // URL上传
        async uploadFromUrl() {
          if (!this.urlToUpload.trim()) {
            this.showToast('请输入有效的URL', 'error');
            return;
          }
          this.urlUploading = true;
          try {
            const response = await fetch(this.urlToUpload);
            const blob = await response.blob();
            const filename = this.urlToUpload.split('/').pop().split('?')[0] || 'image.jpg';
            const file = new File([blob], filename, { type: blob.type });
            this.processFiles([file]);
            this.urlToUpload = '';
          } catch (err) {
            this.showToast('无法获取URL内容：' + err.message, 'error');
          }
          this.urlUploading = false;
        },

        // 处理文件列表
        async processFiles(files) {
          const valid = [];
          const invalid = [];

          files.forEach(file => {
            if (file.size > this.uploadConfig.maxSize) {
              invalid.push(file.name);
            } else {
              valid.push(file);
            }
          });

          if (invalid.length > 0) {
            this.showToast(`${invalid.length}个文件超过100MB限制`, 'error');
          }

          if (valid.length === 0) return;

          // 添加到上传队列
          for (const file of valid) {
            const uploadItem = {
              name: file.name,
              size: file.size,
              file: file,
              status: 'waiting',
              preview: null,
              progress: 0,
              isChunked: file.size > this.uploadConfig.smallFileThreshold
            };

            // 生成预览
            if (file.type.startsWith('image/')) {
              uploadItem.preview = URL.createObjectURL(file);
            }

            this.uploadingFiles.push(uploadItem);
          }

          // 开始并发上传
          await this.startUpload();
        },

        // 开始上传
        async startUpload() {
          const waiting = this.uploadingFiles.filter(f => f.status === 'waiting');
          const concurrent = this.uploadConfig.maxConcurrent;

          for (let i = 0; i < waiting.length; i += concurrent) {
            const batch = waiting.slice(i, i + concurrent);
            await Promise.all(batch.map(item => this.uploadFile(item)));
          }

          // 上传完成
          const successCount = this.uploadingFiles.filter(f => f.status === 'success').length;
          if (successCount > 0) {
            this.showToast(`成功上传 ${successCount} 个文件到 ${this.storageTarget}`, 'success');
          }

          // 清理完成的上传项
          setTimeout(() => {
            this.uploadingFiles = this.uploadingFiles.filter(f => f.status !== 'success');
          }, 2000);
        },

        // 上传单个文件
        async uploadFile(item) {
          item.status = 'uploading';
          item.progress = 0;

          try {
            // 根据文件大小决定使用普通上传还是分片上传
            if (item.isChunked) {
              await this.chunkedUpload(item);
            } else {
              await this.directUpload(item);
            }
          } catch (err) {
            item.status = 'error';
            item.error = err.message;
            console.error('Upload error:', err);
          }
        },

        // 直接上传（小文件 <20MB）
        async directUpload(item) {
          const formData = new FormData();
          formData.append('file', item.file);
          formData.append('storageMode', this.storageMode);

          const response = await fetch(`${this.baseURL}/upload`, {
            method: 'POST',
            body: formData,
            credentials: 'include'
          });

          const data = await response.json();

          if (!response.ok || (Array.isArray(data) && data[0]?.error)) {
            throw new Error(data[0]?.error || '上传失败');
          }

          const src = data[0]?.src;
          if (!src) throw new Error('未返回文件路径');

          item.status = 'success';
          item.progress = 100;
          this.handleUploadSuccess(item, src);
        },

        // 分片上传（大文件 >=20MB）
        async chunkedUpload(item) {
          const file = item.file;
          const chunkSize = this.uploadConfig.chunkSize;
          const totalChunks = Math.ceil(file.size / chunkSize);

          // 1. 初始化上传
          const initResponse = await fetch(`${this.baseURL}/api/chunked-upload/init`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              fileName: file.name,
              fileSize: file.size,
              fileType: file.type,
              totalChunks: totalChunks,
              storageMode: this.storageMode
            }),
            credentials: 'include'
          });

          const initData = await initResponse.json();
          if (!initResponse.ok) {
            throw new Error(initData.error || '初始化上传失败');
          }

          const uploadId = initData.uploadId;

          // 2. 上传分片
          for (let i = 0; i < totalChunks; i++) {
            const start = i * chunkSize;
            const end = Math.min(start + chunkSize, file.size);
            const chunk = file.slice(start, end);

            const formData = new FormData();
            formData.append('chunk', chunk);
            formData.append('uploadId', uploadId);
            formData.append('chunkIndex', i);

            const chunkResponse = await fetch(`${this.baseURL}/api/chunked-upload/chunk`, {
              method: 'POST',
              body: formData,
              credentials: 'include'
            });

            if (!chunkResponse.ok) {
              const errData = await chunkResponse.json();
              throw new Error(errData.error || `分片 ${i + 1} 上传失败`);
            }

            // 更新进度
            item.progress = Math.round(((i + 1) / totalChunks) * 90); // 留 10% 给合并
          }

          // 3. 完成上传
          const completeResponse = await fetch(`${this.baseURL}/api/chunked-upload/complete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uploadId }),
            credentials: 'include'
          });

          const completeData = await completeResponse.json();
          if (!completeResponse.ok) {
            throw new Error(completeData.error || '合并分片失败');
          }

          item.status = 'success';
          item.progress = 100;
          this.handleUploadSuccess(item, completeData.src);
        },

        // 处理上传成功
        handleUploadSuccess(item, src) {
          const uploadedFile = {
            name: item.file.name,
            url: `${this.baseURL}${src}`,
            path: src,
            size: item.file.size,
            selected: false,
            uploadTime: Date.now()
          };

          this.uploadedFiles.unshift(uploadedFile);
          this.addToHistory(uploadedFile);
        },

        // 格式化链接
        formatLink(file) {
          const url = file.url;
          const name = file.name;
          switch (this.linkFormat) {
            case 'markdown':
              return `![${name}](${url})`;
            case 'html':
              return `<img src="${url}" alt="${name}">`;
            case 'bbcode':
              return `[img]${url}[/img]`;
            case 'ubb':
              return `[IMG]${url}[/IMG]`;
            default:
              return url;
          }
        },

        // 获取批量链接
        getBatchLinks() {
          const selected = this.uploadedFiles.filter(f => f.selected);
          const files = selected.length > 0 ? selected : this.uploadedFiles;
          return files.map(f => this.formatLink(f)).join('\n');
        },

        // 复制链接
        copyLink(file) {
          const link = this.formatLink(file);
          this.copyToClipboard(link);
          this.showToast('链接已复制', 'success');
        },

        // 复制选中链接
        copySelectedLinks() {
          const links = this.uploadedFiles.filter(f => f.selected).map(f => this.formatLink(f)).join('\n');
          this.copyToClipboard(links);
          this.showToast(`已复制 ${this.selectedCount} 个链接`, 'success');
        },

        // 复制全部链接
        copyAllLinks() {
          const links = this.uploadedFiles.map(f => this.formatLink(f)).join('\n');
          this.copyToClipboard(links);
          this.showToast(`已复制 ${this.uploadedFiles.length} 个链接`, 'success');
        },

        // 选择全部
        selectAll() {
          const newState = !this.isAllSelected;
          this.uploadedFiles.forEach(f => f.selected = newState);
        },

        // 清空结果
        clearResults() {
          this.uploadedFiles = [];
        },

        // 清空上传队列
        clearUploadQueue() {
          this.uploadingFiles = this.uploadingFiles.filter(f => f.status === 'uploading');
          if (this.uploadingFiles.length === 0) {
            this.showToast('队列已清空', 'success');
          }
        },

        // 重试单个失败项
        async retryUpload(item) {
          item.status = 'waiting';
          item.error = null;
          item.progress = 0;
          await this.uploadFile(item);
        },

        // 重试所有失败项
        async retryAllFailed() {
          const failed = this.uploadingFiles.filter(f => f.status === 'error');
          if (failed.length === 0) return;
          
          this.showToast(`正在重试 ${failed.length} 个失败项...`, 'info');
          
          // 重置状态
          failed.forEach(item => {
            item.status = 'waiting';
            item.error = null;
            item.progress = 0;
          });
          
          // 开始并发上传
          const concurrent = this.uploadConfig.maxConcurrent;
          for (let i = 0; i < failed.length; i += concurrent) {
            const batch = failed.slice(i, i + concurrent);
            await Promise.all(batch.map(item => this.uploadFile(item)));
          }
          
          const successCount = failed.filter(f => f.status === 'success').length;
          if (successCount > 0) {
            this.showToast(`重试成功 ${successCount}/${failed.length} 个文件`, 'success');
          }
        },

        // 从结果中移除
        removeFromResults(index) {
          this.uploadedFiles.splice(index, 1);
        },

        // 下载文件
        downloadFile(file) {
          const link = document.createElement('a');
          link.href = file.url;
          link.download = file.name;
          link.click();
        },

        // 预览图片
        previewImage(url) {
          this.previewUrl = url;
        },

        // 打开预览页面
        openPreview(file) {
          const ext = file.name.split('.').pop().toLowerCase();
          const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg', 'ico'];
          
          if (imageExts.includes(ext)) {
            // 图片直接在弹窗预览
            this.previewUrl = file.url;
          } else {
            // 其他文件跳转到预览页
            window.open(`./preview.html?file=${encodeURIComponent(file.path)}`, '_blank');
          }
        },

        // 历史记录相关
        addToHistory(file) {
          // 避免重复
          const exists = this.uploadHistory.find(h => h.url === file.url);
          if (!exists) {
            this.uploadHistory.unshift({ ...file, selected: false });
            this.saveHistory();
          }
        },

        selectAllHistory() {
          const newState = !this.isAllHistorySelected;
          this.uploadHistory.forEach(f => f.selected = newState);
        },

        toggleHistorySelect(index) {
          this.uploadHistory[index].selected = !this.uploadHistory[index].selected;
        },

        copySelectedHistoryLinks() {
          const links = this.uploadHistory.filter(f => f.selected).map(f => this.formatLink(f)).join('\n');
          this.copyToClipboard(links);
          this.showToast(`已复制 ${this.selectedHistoryCount} 个链接`, 'success');
        },

        removeFromHistory(index) {
          this.uploadHistory.splice(index, 1);
          this.saveHistory();
        },

        clearHistory() {
          this.$confirm('确定要清空所有上传历史吗？', '提示', {
            type: 'warning'
          }).then(() => {
            this.uploadHistory = [];
            this.saveHistory();
            this.showToast('历史记录已清空', 'success');
          }).catch(() => {});
        },

        saveHistory() {
          localStorage.setItem('uploadHistory', JSON.stringify(this.uploadHistory));
        },

        loadHistory() {
          try {
            const history = localStorage.getItem('uploadHistory');
            if (history) {
              this.uploadHistory = JSON.parse(history).map(h => ({ ...h, selected: false }));
            }
          } catch (e) {
            this.uploadHistory = [];
          }
        },

        // 工具方法
        formatSize(bytes) {
          if (!bytes) return '0 B';
          const units = ['B', 'KB', 'MB', 'GB'];
          let i = 0;
          while (bytes >= 1024 && i < units.length - 1) {
            bytes /= 1024;
            i++;
          }
          return bytes.toFixed(i > 0 ? 2 : 0) + ' ' + units[i];
        },

        getStatusText(status) {
          const texts = {
            waiting: '等待中',
            uploading: '上传中',
            success: '成功',
            error: '失败'
          };
          return texts[status] || status;
        },

        getFileIcon(filename) {
          const ext = filename.split('.').pop().toLowerCase();
          const iconMap = {
            'pdf': 'fas fa-file-pdf',
            'doc,docx': 'fas fa-file-word',
            'xls,xlsx,csv': 'fas fa-file-excel',
            'ppt,pptx': 'fas fa-file-powerpoint',
            'txt,md,log': 'fas fa-file-lines',
            'mp4,webm,avi,mov,wmv,flv,mkv,m4v,3gp,ts': 'fas fa-file-video',
            'mp3,wav,ogg,flac,aac,m4a,wma,ape,opus': 'fas fa-file-audio',
            'zip,rar,7z,tar,gz,bz2': 'fas fa-file-zipper',
            'exe,msi,dmg,deb,rpm': 'fas fa-file-arrow-down',
            'apk': 'fab fa-android',
            'iso,img': 'fas fa-compact-disc',
            'json,xml,yaml,yml,toml': 'fas fa-file-code',
            'html,htm,css,js,ts,jsx,tsx,vue,php,py,java,c,cpp,h,hpp,cs,go,rs,rb,pl,sh,sql': 'fas fa-file-code',
            'jpg,jpeg,png,gif,webp,bmp,svg,ico,heic,heif,avif': 'fas fa-file-image',
            'psd,ai,eps,cdr': 'fas fa-file-image'
          };
          for (const [exts, icon] of Object.entries(iconMap)) {
            if (exts.split(',').includes(ext)) return icon;
          }
          return 'fas fa-file';
        },

        copyToClipboard(text) {
          if (navigator.clipboard) {
            navigator.clipboard.writeText(text);
          } else {
            const textarea = document.createElement('textarea');
            document.body.appendChild(textarea);
            textarea.value = text;
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
          }
        },

        showToast(message, type = 'info') {
          const toast = { message, type };
          this.toasts.push(toast);
          setTimeout(() => {
            const index = this.toasts.indexOf(toast);
            if (index > -1) this.toasts.splice(index, 1);
          }, 3000);
        },

        getToastIcon(type) {
          const icons = {
            success: 'fas fa-check-circle',
            error: 'fas fa-times-circle',
            info: 'fas fa-info-circle'
          };
          return icons[type] || icons.info;
        },

        // 退出登录
        async handleLogout() {
          try {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            window.location.href = '/login.html';
          } catch (e) {
            this.showToast('退出失败', 'error');
          }
        },

        // 检查认证状态
        async checkAuth() {
          try {
            const response = await fetch('/api/auth/check', { credentials: 'include' });
            const data = await response.json();
            
            // 如果需要认证但未认证，跳转到登录页面
            if (data.authRequired && !data.authenticated) {
              window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
              return;
            }
            
            this.isAuthenticated = data.authRequired && data.authenticated;
          } catch (e) {
            console.error('Auth check failed:', e);
          }
        },

        // 检查存储目标
        async checkStorageTarget() {
          try {
            const response = await fetch('/api/status', { credentials: 'include' });
            const status = await response.json();
            // 检查 R2 是否可用
            this.r2Available = status.r2?.connected && status.r2?.enabled;
            // 默认使用 Telegram，如果用户之前选择了 R2 且 R2 可用则使用 R2
            const savedMode = localStorage.getItem('storageMode');
            if (savedMode === 'r2' && this.r2Available) {
              this.storageMode = 'r2';
              this.storageTarget = 'R2 存储桶';
            } else {
              this.storageMode = 'telegram';
              this.storageTarget = 'Telegram 频道';
            }
          } catch (e) {
            this.storageMode = 'telegram';
            this.storageTarget = 'Telegram 频道';
            this.r2Available = false;
          }
        },

        // 切换存储模式
        setStorageMode(mode) {
          if (mode === 'r2' && !this.r2Available) {
            this.showToast('R2 存储未配置或未启用', 'error');
            return;
          }
          this.storageMode = mode;
          this.storageTarget = mode === 'r2' ? 'R2 存储桶' : 'Telegram 频道';
          localStorage.setItem('storageMode', mode);
          this.showToast(`已切换到 ${this.storageTarget}`, 'success');
        }
      },
      mounted() {
        // 检查认证状态（优先执行）
        this.checkAuth();

        // 检查存储目标
        this.checkStorageTarget();

        // 加载历史记录
        this.loadHistory();

        // 全局粘贴事件
        document.addEventListener('paste', async (e) => {
          const items = e.clipboardData?.items;
          if (!items) return;

          const files = [];
          for (const item of items) {
            if (item.type.startsWith('image/')) {
              const blob = item.getAsFile();
              if (blob) {
                const ext = item.type.split('/')[1];
                const file = new File([blob], `paste_${Date.now()}.${ext}`, { type: item.type });
                files.push(file);
              }
            }
          }

          if (files.length > 0) {
            e.preventDefault();
            this.processFiles(files);
          }
        });

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
          // Ctrl+V 已通过 paste 事件处理
          // Escape 关闭预览
          if (e.key === 'Escape' && this.previewUrl) {
            this.previewUrl = null;
          }
        });
      }
    });
  </script>
</body>
</html>
